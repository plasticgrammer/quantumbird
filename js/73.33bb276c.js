"use strict";(self["webpackChunkweekly_report"]=self["webpackChunkweekly_report"]||[]).push([[73],{4972:function(e,t,a){a.d(t,{t:function(){return g}});var l,n=a(689),o="https://js.stripe.com/v3",r=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,c="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",i=function(){for(var e=document.querySelectorAll('script[src^="'.concat(o,'"]')),t=0;t<e.length;t++){var a=e[t];if(r.test(a.src))return a}return null},s=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",a=document.createElement("script");a.src="".concat(o).concat(t);var l=document.head||document.body;if(!l)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return l.appendChild(a),a},u=function(e,t){e&&e._registerWrapper&&e._registerWrapper({name:"stripe-js",version:"4.8.0",startTime:t})},d=null,p=null,m=null,v=function(e){return function(){e(new Error("Failed to load Stripe.js"))}},f=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},h=function(e){return null!==d?d:(d=new Promise((function(t,a){if("undefined"!==typeof window&&"undefined"!==typeof document)if(window.Stripe&&e&&console.warn(c),window.Stripe)t(window.Stripe);else try{var l=i();if(l&&e)console.warn(c);else if(l){if(l&&null!==m&&null!==p){var n;l.removeEventListener("load",m),l.removeEventListener("error",p),null===(n=l.parentNode)||void 0===n||n.removeChild(l),l=s(e)}}else l=s(e);m=f(t,a),p=v(a),l.addEventListener("load",m),l.addEventListener("error",p)}catch(o){return void a(o)}else t(null)})),d["catch"]((function(e){return d=null,Promise.reject(e)})))},w=function(e,t,a){if(null===e)return null;var l=e.apply(void 0,t);return u(l,a),l},y=!1,x=function(){return l||(l=h(null)["catch"]((function(e){return l=null,Promise.reject(e)})),l)};Promise.resolve().then((function(){return x()}))["catch"]((function(e){y||console.warn(e)}));var N=function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];y=!0;var l=Date.now();return x().then((function(e){return w(e,t,l)}))},V=a(1126);function g(){const e=(0,n.ref)(null),t=(0,n.ref)(null),a=(0,n.reactive)({}),l=async()=>{try{const a="pk_live_51QHQHGJlLYAT4bpzDkO3xlMNRFulS3FfwANFbrOXzlejkQVqEXZEAKus9vC8UYxhYGyt8KRklGkKqRGGMT9umz7h00oyAPHjf2";if(!a)throw new Error("Stripe public key is not set");return e.value&&t.value||(e.value=await N(a),t.value=e.value.elements({locale:"ja"}),await new Promise((e=>setTimeout(e,100)))),{stripe:e.value,elements:t.value}}catch(a){throw a}},o=async e=>{if(!t.value)throw new Error("Stripe Elements has not been initialized");try{a[e]&&(a[e].destroy(),delete a[e]),await new Promise((e=>setTimeout(e,100)));const l=document.getElementById(e);if(!l)throw new Error(`Mount point #${e} not found`);return a[e]=t.value.create("card",{style:{base:{fontSize:"16px",color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',"::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},hidePostalCode:!0}),await new Promise((e=>setTimeout(e,100))),a[e].mount(`#${e}`),a[e]}catch(l){throw l}},r=async(t,l)=>{if(!e.value||!a[t])throw new Error("Stripe has not been initialized");return e.value.createToken(a[t],l)},c=e=>{a[e]&&(a[e].destroy(),delete a[e])},i=()=>{Object.keys(a).forEach((e=>{c(e)})),e.value=null,t.value=null};return{stripe:e,elements:t,cards:a,plans:V.vw,initializeStripe:l,createCardElement:o,createToken:r,destroyCardElement:c,cleanup:i}}},7073:function(e,t,a){a.r(t),a.d(t,{default:function(){return Ve}});var l=a(689),n=a(834),o=a(4972),r=a(2599),c=a(1114),i=a(1126),s=(a(4114),a(6211)),u=a(6756),d=a(9244),p=a(4473),m=a(7495);const v={class:"mt-4"},f=["id"],h={key:0,class:"error--text mt-2"},w={key:0};var y={__name:"PaymentMethodForm",props:{elementId:{type:String,required:!0},loading:{type:Boolean,default:!1},showSubmitButton:{type:Boolean,default:!1}},emits:["submit","error"],setup(e,{expose:t,emit:a}){const n=e,r=a,c=(0,l.ref)(null),i=(0,l.ref)(""),{initializeStripe:s,createCardElement:u,createToken:y,destroyCardElement:x}=(0,o.t)(),N=(0,l.reactive)({cardName:""}),V=(0,l.reactive)({cardName:[e=>!!e||"カード名義は必須です"]}),g=async()=>{const e=c.value;if(!e)return null;const{valid:t}=await e.validate();if(!t)return null;i.value="";try{const{token:e,error:t}=await y(n.elementId,{name:N.cardName});if(t)throw new Error(t.message);return{token:e}}catch(a){return i.value=a.message||"処理に失敗しました",r("error",i.value),null}};t({submit:g});const k=async()=>{const e=await g();e&&r("submit",{token:e.token})};return(0,l.onMounted)((async()=>{try{await(0,l.nextTick)();const{stripe:e,elements:t}=await s();if(!e||!t)throw new Error("Stripe initialization failed");const a=await u(n.elementId);if(!a)throw new Error("Card element creation failed");a.on("change",(e=>{e.error?(i.value=e.error.message,r("error",i.value)):i.value=""})),c.value&&c.value.reset()}catch(e){i.value=e.message||"カード要素の初期化に失敗しました",r("error",i.value)}})),(0,l.onUnmounted)((()=>{x(n.elementId)})),(t,a)=>((0,l.openBlock)(),(0,l.createBlock)(p.n,{ref_key:"formRef",ref:c,onSubmit:(0,l.withModifiers)(k,["prevent"])},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(m.W,{modelValue:N.cardName,"onUpdate:modelValue":a[0]||(a[0]=e=>N.cardName=e),label:"カード名義",rules:V.cardName,required:""},null,8,["modelValue","rules"]),(0,l.createElementVNode)("div",v,[a[1]||(a[1]=(0,l.createElementVNode)("label",{class:"text-subtitle-1"},"カード情報",-1)),(0,l.createElementVNode)("div",{id:e.elementId,class:"mt-2 pa-4 stripe-element",style:{"min-height":"40px"}},null,8,f),i.value?((0,l.openBlock)(),(0,l.createElementBlock)("div",h,(0,l.toDisplayString)(i.value),1)):(0,l.createCommentVNode)("",!0)]),e.showSubmitButton?((0,l.openBlock)(),(0,l.createElementBlock)("div",w,[(0,l.renderSlot)(t.$slots,"submit-button",{},(()=>[(0,l.createVNode)(d.D,{type:"submit",color:"primary",class:"mt-6",block:"",size:"large",loading:e.loading,disabled:e.loading,onClick:(0,l.withModifiers)(k,["prevent"])},{default:(0,l.withCtx)((()=>a[2]||(a[2]=[(0,l.createTextVNode)(" 支払い方法を更新 ")]))),_:1},8,["loading","disabled"])]))])):(0,l.createCommentVNode)("",!0)])),_:3},512))}},x=a(6262);const N=(0,x.A)(y,[["__scopeId","data-v-20bab69e"]]);var V=N,g=a(9660),k=a(3725),C=a(3960),b=a(6051),E=a(1652),I=a(9494),B=a(8703),_=a(9663);const S={key:0,class:"px-4 py-0"},P={style:{"min-height":"30px"}},D={class:"text-h6 font-weight-bold"},T={class:"text-h4 font-weight-bold mb-2 text-center",style:{"min-height":"130px"}},z={class:"text-body-1 mb-2"},L={class:"text-subtitle-1 font-weight-regular"},M={class:"text-h6 mt-2"},j={class:"mb-2"},A={key:0,class:"mt-1 ml-2"},F={key:1,class:"mt-1 ml-2"},$={class:"ml-2"},O={key:1,class:"mt-1 ml-2"},J={class:"mb-0"},Y={key:0},Q={class:"d-flex align-center"},R={class:"text-body-2"},U=["href"],q={class:"d-flex gap-2 pt-2"},H={key:2,class:"mb-4"},G={class:"d-flex align-center justify-space-between"},K={class:"d-flex align-center"},W={class:"ml-2 text-caption"},Z={class:"my-2"},X={class:"text-subtitle-1 font-weight-bold mb-2"},ee={class:"text-body-1"},te={class:"text-body-1"},ae={key:1,class:"text-body-1"},le={key:2,class:"text-body-1"};var ne={__name:"PaymentDialog",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue","payment-success"],setup(e,{emit:t}){const a=e,p=t,v=(0,l.computed)({get:()=>a.modelValue,set:e=>p("update:modelValue",e)}),f=()=>{de.value=!1,v.value=!1},h=(0,n.Pj)(),{initializeStripe:w,cleanup:y,plans:x}=(0,o.t)(),N=(0,l.ref)(null),ne=(0,l.inject)("showNotification"),oe=(0,l.inject)("showError"),re=(0,l.reactive)({cardName:"",selectedPlan:null,accountCount:1,validation:{accountCount:[]}}),ce={accountCount:[e=>!!e||"アカウント数は必須です",e=>e>0||"アカウント数は1以上を指定してください",e=>Number.isInteger(Number(e))||"整数を入力してください"]},ie=(0,l.ref)(null),se=(0,l.ref)(!1),ue=(0,l.ref)(""),de=(0,l.ref)(!1),pe=(0,l.ref)(!1),me=(0,l.ref)(!1),ve=(0,l.ref)("plan-selection"),fe=new AbortController,he=(0,l.ref)(!1),we=(0,l.ref)(""),ye=(0,l.ref)(null),xe=(0,l.ref)(0),Ne=(0,l.computed)((()=>{const e=(0,i.P8)(),t=(0,i.zN)();return t?{...e,subscriptionId:t.subscriptionId||null,currentAccountCount:t.accountCount||0,stripeCustomerId:t.stripeCustomerId}:e})),Ve=e=>re.selectedPlan===e.planId?"indigo-lighten-1":Ne.value?.planId===e.planId?"indigo-lighten-5":"",ge=e=>{oe(e.message||"エラーが発生しました")},ke=()=>{re.cardName="",ue.value=""},Ce=async({token:e})=>{try{const t=x.find((e=>e.planId===re.selectedPlan)),a=h.state.auth.user.email,l=await(0,r.Ky)({email:a,token:e.id,priceId:t.priceId,accountCount:"business"===re.selectedPlan?re.accountCount:0});await h.dispatch("auth/updateSubscriptionAttributes",{stripeCustomerId:l.subscription.stripeCustomerId,planId:re.selectedPlan,accountCount:"business"===re.selectedPlan?re.accountCount:null,subscriptionId:l.subscription.id}),be()}catch(t){ge(t)}},be=async()=>{we.value="",ke(),ve.value="plan-selection",p("payment-success"),de.value=!0},Ee=async()=>{try{if(!Ne.value?.stripeCustomerId)return;const e=h.state.auth.user;if(!e)return;const t=await(0,r.J5)(e.email);if(!t?.data?.paymentMethods?.length)return void(ie.value=null);const[a]=t.data.paymentMethods,l=!ie.value||ie.value.last4!==a.last4||ie.value.expMonth!==a.expMonth||ie.value.expYear!==a.expYear;l&&(ie.value={last4:a.last4,expMonth:a.expMonth,expYear:a.expYear})}catch(e){if("AbortError"!==e.name)throw ie.value=null,e}},Ie=async()=>{try{he.value=!0,me.value=!1,await Ee(),ve.value="payment"}catch(e){oe("支払い情報の取得に失敗しました"),ve.value="plan-selection"}finally{he.value=!1}},Be=async({token:e})=>{try{if(pe.value=!0,ue.value="",!Ne.value?.stripeCustomerId)throw new Error("顧客情報が見つかりません");if(!e?.id)throw new Error("カード情報が不正です");const t=await(0,r.zA)({token:e.id,customerId:Ne.value.stripeCustomerId});if(!t?.paymentMethod)throw new Error("カード情報の更新に失敗しました");ie.value={last4:t.paymentMethod.last4,expMonth:t.paymentMethod.expMonth,expYear:t.paymentMethod.expYear},me.value=!1,ne("支払い方法を更新しました","success")}catch(t){oe(t.message||"支払い方法の更新に失敗しました")}finally{pe.value=!1}},_e=()=>{const e=[];return ze.value&&e.push(Le.value),"business"===re.selectedPlan&&(!re.accountCount||re.accountCount<1)&&e.push("アカウント数は1以上を指定してください"),e},Se=async e=>{try{se.value=!0,ue.value="",we.value="";const t="business"===Ne.value?.planId&&e.priceId===x.find((e=>"business"===e.planId)).priceId,a={...e,proration_behavior:t?"none":"create_prorations",payment_behavior:"default_incomplete",collection_method:"charge_automatically",billing_cycle_anchor:t?"unchanged":"now"},l=await(0,r.cI)(a);return l.message&&(l.subscription?.cancelAt?(de.value=!0,we.value=l.message):(await h.dispatch("auth/updateSubscriptionAttributes",{planId:re.selectedPlan,accountCount:"business"===re.selectedPlan?re.accountCount:null,stripeCustomerId:l.subscription.stripeCustomerId}),be())),!0}catch(t){return ge(t),!1}finally{se.value=!1}},Pe=async()=>{try{const t=_e();if(t.length>0)return void oe(t[0]);if(re.selectedPlan===Ne.value?.planId&&"business"!==re.selectedPlan&&!me.value)return void oe("同じプランへの変更はできません");const a=x.find((e=>e.planId===re.selectedPlan));if(!a)return void oe("無効なプランが選択されました");if(se.value=!0,"free"===re.selectedPlan)try{const e=(0,i.zN)(),t=e?.stripeCustomerId;if(Ne.value?.subscriptionId){const e=await(0,r.cI)({subscriptionId:Ne.value.subscriptionId,priceId:"price_free",accountCount:0,customerId:t});await h.dispatch("auth/updateSubscriptionAttributes",{planId:"free",priceId:"price_free",accountCount:null,subscriptionId:null,stripeCustomerId:e.subscription.stripeCustomerId||t}),e.message&&(we.value=e.message),be()}else await h.dispatch("auth/updateSubscriptionAttributes",{planId:"free",priceId:"price_free",accountCount:null,subscriptionId:null,stripeCustomerId:t}),be()}catch(e){ge(e)}else{const e=(0,i.zN)(),t=!e?.subscriptionId||"free"===e?.planId;if(t)if(ie.value){const e=await(0,r.Ky)({email:h.state.auth.user.email,token:null,priceId:a.priceId,accountCount:"business"===re.selectedPlan?re.accountCount:0,customerId:(0,i.zN)()?.stripeCustomerId});e.subscription&&(await h.dispatch("auth/updateSubscriptionAttributes",{stripeCustomerId:e.subscription.stripeCustomerId}),be())}else{const e=await(N.value?.submit());if(!e?.token)return;await Ce({token:e.token})}else await Se({subscriptionId:Ne.value.subscriptionId,priceId:a.priceId,accountCount:"business"===re.selectedPlan?re.accountCount:0})}}catch(e){oe(e.message||"処理に失敗しました")}finally{se.value=!1}},De=(0,l.computed)((()=>"free"!==re.selectedPlan||"free"!==Ne.value?.planId)),Te=(0,l.computed)((()=>ye.value?.members?.length||0)),ze=(0,l.computed)((()=>{if(!re.selectedPlan)return!1;const e=x.find((e=>e.planId===re.selectedPlan));if("business"===re.selectedPlan)return re.accountCount<xe.value;{const t=e?.adminFeatures?.accountCount||0;if(xe.value>0&&0===t)return!0;const a=e?.adminFeatures?.maxMembers;return!(!a||-1===a)&&Te.value>a}})),Le=(0,l.computed)((()=>{if(!ze.value)return"";const e=x.find((e=>e.planId===re.selectedPlan)),t=[];if("business"===re.selectedPlan)re.accountCount<xe.value&&t.push(`設定したいアカウント数(${re.accountCount}個)が現在の子アカウント数(${xe.value}個)より少ないため変更できません。\n${xe.value}以上のアカウント数を設定するか、子アカウントを削除してください。`);else{xe.value>0&&t.push("選択したプランでは子アカウントを使用できません。\nすべての子アカウントを削除してから再度お試しください。");const a=e.adminFeatures.maxMembers;-1!==a&&Te.value>a&&t.push(`現在のメンバー数(${Te.value}名)が選択したプランの上限(${a}名)を超えています。\nメンバーを削除してから再度お試しください。`)}return t.join("\n\n")})),Me=async({token:e})=>{e&&await Be({token:e})};return(0,l.onMounted)((async()=>{try{await(0,l.nextTick)();const{stripe:e,error:t}=await w();if(t||!e)throw new Error(t||"Stripe initialization failed");const a=h.getters["auth/organizationId"],[n,o]=await Promise.all([(0,c.SA)(a),(0,u.P4)({parentOrganizationId:a})]);n&&Object.keys(n).length>0&&(ye.value=n),xe.value=o?.length||0;const r=h.state.auth.user;r?(re.email=r.email,re.selectedPlan=h.getters["auth/currentSubscription"]?.planId||"free"):re.selectedPlan="free",Ne.value&&(re.accountCount="business"===Ne.value.planId?Ne.value.currentAccountCount:1)}catch(e){"AbortError"===!e.name&&ge(e,"初期化に失敗しました")}})),(0,l.onUnmounted)((()=>{fe.abort(),y()})),(e,t)=>((0,l.openBlock)(),(0,l.createBlock)(b.p,{modelValue:v.value,"onUpdate:modelValue":t[8]||(t[8]=e=>v.value=e),"max-width":"960px"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.Jn,{rounded:"lg"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.ri,{class:"pb-2"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(B.wP,{class:"mr-2"},{default:(0,l.withCtx)((()=>t[9]||(t[9]=[(0,l.createTextVNode)("mdi-wallet-membership")]))),_:1}),t[10]||(t[10]=(0,l.createTextVNode)(" プラン変更 ")),(0,l.createVNode)(d.D,{icon:"mdi-close",variant:"text",size:"small",class:"float-right",onClick:f})])),_:1}),(0,l.createVNode)(k.OQ,null,{default:(0,l.withCtx)((()=>["plan-selection"===ve.value?((0,l.openBlock)(),(0,l.createElementBlock)("div",S,[(0,l.createVNode)(I.Li,{justify:"center"},{default:(0,l.withCtx)((()=>[((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)((0,l.unref)(x),(e=>((0,l.openBlock)(),(0,l.createBlock)(I.B6,{key:e.planId,cols:"12",md:"4",class:"pa-3"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.Jn,{color:Ve(e),class:(0,l.normalizeClass)([["plan-card",re.selectedPlan===e.planId?"selected-plan":"",Ne.value?.planId===e.planId?"current-plan":""],"rounded-lg cursor-pointer position-relative"]),elevation:"4",onClick:t=>re.selectedPlan=e.planId},{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",P,[Ne.value?.planId===e.planId?((0,l.openBlock)(),(0,l.createBlock)(C.x,{key:0,color:re.selectedPlan===e.planId?"white":"info",class:"current-plan-badge font-weight-bold",size:"small",label:""},{default:(0,l.withCtx)((()=>t[11]||(t[11]=[(0,l.createTextVNode)(" 現在のプラン ")]))),_:2},1032,["color"])):(0,l.createCommentVNode)("",!0)]),(0,l.createVNode)(k.ri,{class:"text-center pt-2"},{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",D,(0,l.toDisplayString)(e.name),1)])),_:2},1024),(0,l.createVNode)(k.OQ,null,{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",T,[(0,l.createElementVNode)("div",null,[(0,l.createTextVNode)(" ¥"+(0,l.toDisplayString)(e.price.toLocaleString()),1),t[12]||(t[12]=(0,l.createElementVNode)("span",{class:"text-body-1"},"/月",-1))]),"business"===e.planId?((0,l.openBlock)(),(0,l.createElementBlock)(l.Fragment,{key:0},[(0,l.createElementVNode)("div",z,[((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(e.priceDescription,((e,t)=>((0,l.openBlock)(),(0,l.createElementBlock)("div",{key:t,class:"price-line"},(0,l.toDisplayString)(e),1)))),128))]),(0,l.createElementVNode)("div",L," アカウント数: "+(0,l.toDisplayString)(re.accountCount),1),(0,l.createElementVNode)("div",M,[(0,l.createTextVNode)(" 合計: ¥"+(0,l.toDisplayString)(e.getPrice(re.accountCount).toLocaleString()),1),t[13]||(t[13]=(0,l.createElementVNode)("span",{class:"text-body-1"},"/月",-1))])],64)):(0,l.createCommentVNode)("",!0)]),(0,l.createVNode)(E.G,{class:"mb-4"}),(0,l.createVNode)(_.x8,{class:"bg-transparent",density:"compact"},{default:(0,l.withCtx)((()=>[((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(e.features,((a,n)=>((0,l.openBlock)(),(0,l.createBlock)(_.gc,{key:n,class:(0,l.normalizeClass)([re.selectedPlan===e.planId?"text-white":"","pr-0"])},{prepend:(0,l.withCtx)((()=>[(0,l.createVNode)(B.wP,{color:re.selectedPlan===e.planId?"white":"primary",size:"small"},{default:(0,l.withCtx)((()=>t[14]||(t[14]=[(0,l.createTextVNode)(" mdi-check-circle ")]))),_:2},1032,["color"])])),default:(0,l.withCtx)((()=>[(0,l.createTextVNode)(" "+(0,l.toDisplayString)(a),1)])),_:2},1032,["class"])))),128))])),_:2},1024)])),_:2},1024)])),_:2},1032,["color","class","onClick"])])),_:2},1024)))),128))])),_:1}),Le.value?((0,l.openBlock)(),(0,l.createBlock)(g.l,{key:0,type:"error",class:"mt-4 white-space-pre-line",variant:"tonal"},{default:(0,l.withCtx)((()=>[(0,l.createTextVNode)((0,l.toDisplayString)(Le.value),1)])),_:1})):(0,l.createCommentVNode)("",!0),(0,l.createVNode)(I.Li,{justify:"center",class:"mt-5 mb-1"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(I.B6,{cols:"12",sm:"8",md:"6"},{default:(0,l.withCtx)((()=>[re.selectedPlan?((0,l.openBlock)(),(0,l.createBlock)(d.D,{key:0,color:"primary",block:"",loading:he.value,disabled:he.value||!De.value||ze.value,onClick:Ie},{default:(0,l.withCtx)((()=>[(0,l.createTextVNode)((0,l.toDisplayString)(he.value?"読み込み中...":"次へ"),1)])),_:1},8,["loading","disabled"])):(0,l.createCommentVNode)("",!0)])),_:1})])),_:1})])):(0,l.createCommentVNode)("",!0),"payment"===ve.value?((0,l.openBlock)(),(0,l.createElementBlock)(l.Fragment,{key:1},[(0,l.createVNode)(k.OQ,{class:"px-6 pb-4"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.Jn,{class:"mb-4 pa-4",variant:"outlined"},{default:(0,l.withCtx)((()=>[t[16]||(t[16]=(0,l.createElementVNode)("div",{class:"text-subtitle-1 mb-2"},"変更内容",-1)),(0,l.createElementVNode)("div",j,[(0,l.createTextVNode)(" 現在のプラン: "+(0,l.toDisplayString)(Ne.value?.name||"なし")+" ",1),"business"===Ne.value?.planId?((0,l.openBlock)(),(0,l.createElementBlock)("div",A,[(0,l.createTextVNode)(" 現在のアカウント数: "+(0,l.toDisplayString)(Ne.value.currentAccountCount)+" ",1),(0,l.createElementVNode)("div",null,"現在の月額料金: ¥"+(0,l.toDisplayString)(Ne.value.getPrice(Ne.value.currentAccountCount).toLocaleString())+"/月",1)])):"pro"===Ne.value?.planId?((0,l.openBlock)(),(0,l.createElementBlock)("div",F," 現在の月額料金: ¥"+(0,l.toDisplayString)(Ne.value.price.toLocaleString())+"/月 ",1)):(0,l.createCommentVNode)("",!0)]),(0,l.createVNode)(E.G,{class:"my-3"}),(0,l.createElementVNode)("div",null,[(0,l.createVNode)(I.Li,null,{default:(0,l.withCtx)((()=>[(0,l.createVNode)(I.B6,{cols:"6"},{default:(0,l.withCtx)((()=>[(0,l.createTextVNode)(" 変更後のプラン: "+(0,l.toDisplayString)((0,l.unref)(x).find((e=>e.planId===re.selectedPlan))?.name)+" ",1),"business"===re.selectedPlan?((0,l.openBlock)(),(0,l.createElementBlock)(l.Fragment,{key:0},[(0,l.createVNode)(m.W,{modelValue:re.accountCount,"onUpdate:modelValue":t[0]||(t[0]=e=>re.accountCount=e),type:"number",label:"アカウント数",class:"mt-3 mb-2 ml-2",rules:ce.accountCount,"hide-details":"auto",density:"compact",variant:"outlined","max-width":"130px",required:""},null,8,["modelValue","rules"]),(0,l.createElementVNode)("div",$," 変更後の月額料金: ¥"+(0,l.toDisplayString)((0,l.unref)(x).find((e=>"business"===e.planId)).getPrice(re.accountCount).toLocaleString())+"/月 ",1)],64)):(0,l.createCommentVNode)("",!0),"pro"===re.selectedPlan?((0,l.openBlock)(),(0,l.createElementBlock)("div",O," 変更後の月額料金: ¥"+(0,l.toDisplayString)((0,l.unref)(x).find((e=>"pro"===e.planId)).price.toLocaleString())+"/月 ",1)):(0,l.createCommentVNode)("",!0)])),_:1}),(0,l.createVNode)(I.B6,{cols:"6"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(g.l,{type:"warning",class:"my-2",variant:"tonal",density:"compact"},{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("ul",J,["free"!==re.selectedPlan?((0,l.openBlock)(),(0,l.createElementBlock)("li",Y,"プラン料金は毎月自動で請求されます")):(0,l.createCommentVNode)("",!0),t[15]||(t[15]=(0,l.createElementVNode)("li",null,"プラン変更は即時適用されます",-1))])])),_:1})])),_:1})])),_:1})])])),_:1}),"pro"===re.selectedPlan||"business"===re.selectedPlan?((0,l.openBlock)(),(0,l.createBlock)(k.Jn,{key:0,class:"mb-4 pa-4",variant:"outlined"},{default:(0,l.withCtx)((()=>[t[31]||(t[31]=(0,l.createElementVNode)("h3",{class:"text-h6 mb-4"},"支払い方法",-1)),(0,l.createVNode)(g.l,{type:"info",icon:"mdi-shield-check",class:"mb-4",variant:"tonal",border:"start"},{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",Q,[(0,l.createElementVNode)("div",null,[t[25]||(t[25]=(0,l.createElementVNode)("div",{class:"font-weight-bold mb-1"},"安全な決済処理",-1)),(0,l.createElementVNode)("div",R,[t[17]||(t[17]=(0,l.createTextVNode)(" 決済処理は")),t[18]||(t[18]=(0,l.createElementVNode)("a",{href:"https://stripe.com/jp",target:"_blank",rel:"noopener",class:"text-indigo"},"Stripe",-1)),t[19]||(t[19]=(0,l.createTextVNode)("を利用しています。")),t[20]||(t[20]=(0,l.createElementVNode)("br",null,null,-1)),t[21]||(t[21]=(0,l.createTextVNode)(" カード情報は暗号化され、Stripeの安全な環境で処理されます。当サービスではカード情報を保持しません。")),t[22]||(t[22]=(0,l.createElementVNode)("br",null,null,-1)),t[23]||(t[23]=(0,l.createTextVNode)(" 詳細は")),(0,l.createElementVNode)("a",{href:(0,l.unref)(s.Rt),target:"_blank",rel:"noopener",class:"text-indigo"},"特定商取引法に基づく表記",8,U),t[24]||(t[24]=(0,l.createTextVNode)("をご確認ください。 "))])])])])),_:1}),ie.value?me.value?((0,l.openBlock)(),(0,l.createBlock)(V,{ref:"updateFormRef",key:"payment-update-"+Date.now(),"element-id":"payment-update",loading:pe.value,"show-submit-button":!0,onSubmit:t[3]||(t[3]=e=>Me(e)),onError:t[4]||(t[4]=e=>ue.value=e)},{"submit-button":(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",q,[(0,l.createVNode)(d.D,{color:"primary",type:"submit",loading:pe.value},{default:(0,l.withCtx)((()=>t[26]||(t[26]=[(0,l.createTextVNode)(" 支払い方法を更新 ")]))),_:1},8,["loading"]),t[28]||(t[28]=(0,l.createElementVNode)("span",{class:"mx-2"},null,-1)),(0,l.createVNode)(d.D,{variant:"outlined",onClick:t[2]||(t[2]=e=>me.value=!1)},{default:(0,l.withCtx)((()=>t[27]||(t[27]=[(0,l.createTextVNode)(" キャンセル ")]))),_:1})])])),_:1},8,["loading"])):((0,l.openBlock)(),(0,l.createElementBlock)("div",H,[(0,l.createElementVNode)("div",G,[(0,l.createElementVNode)("div",K,[(0,l.createVNode)(B.wP,{class:"mr-2"},{default:(0,l.withCtx)((()=>t[29]||(t[29]=[(0,l.createTextVNode)("mdi-credit-card")]))),_:1}),(0,l.createElementVNode)("span",null,"**** **** **** "+(0,l.toDisplayString)(ie.value.last4),1),(0,l.createElementVNode)("span",W," 有効期限: "+(0,l.toDisplayString)(String(ie.value.expMonth).padStart(2,"0"))+"/"+(0,l.toDisplayString)(String(ie.value.expYear).slice(-2)),1)]),(0,l.createVNode)(d.D,{variant:"text",color:"primary",onClick:t[5]||(t[5]=e=>me.value=!0)},{default:(0,l.withCtx)((()=>t[30]||(t[30]=[(0,l.createTextVNode)(" 支払い方法を変更 ")]))),_:1})])])):((0,l.openBlock)(),(0,l.createBlock)(V,{key:0,ref_key:"paymentFormRef",ref:N,"element-id":"payment-form",loading:se.value,"show-submit-button":!1,onError:t[1]||(t[1]=e=>ue.value=e)},null,8,["loading"]))])),_:1})):(0,l.createCommentVNode)("",!0),me.value?(0,l.createCommentVNode)("",!0):((0,l.openBlock)(),(0,l.createBlock)(d.D,{key:1,color:"primary",block:"",size:"large",loading:se.value,disabled:se.value||!re.selectedPlan||ze.value,onClick:(0,l.withModifiers)(Pe,["prevent"])},{default:(0,l.withCtx)((()=>[(0,l.createTextVNode)((0,l.toDisplayString)(se.value?"処理中...":"free"===re.selectedPlan?"プランを解約する":"プランを変更する"),1)])),_:1},8,["loading","disabled"]))])),_:1}),(0,l.createVNode)(k.OQ,{class:"px-6 pt-4"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(d.D,{variant:"outlined",onClick:t[6]||(t[6]=e=>ve.value="plan-selection")},{default:(0,l.withCtx)((()=>t[32]||(t[32]=[(0,l.createTextVNode)(" プラン選択に戻る ")]))),_:1})])),_:1})],64)):(0,l.createCommentVNode)("",!0),(0,l.createVNode)(b.p,{modelValue:de.value,"onUpdate:modelValue":t[7]||(t[7]=e=>de.value=e),"max-width":"400"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.Jn,{rounded:"lg"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.ri,{class:"text-h6"},{default:(0,l.withCtx)((()=>t[33]||(t[33]=[(0,l.createTextVNode)("プラン変更完了")]))),_:1}),(0,l.createVNode)(k.OQ,null,{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",Z,(0,l.toDisplayString)(we.value||"以下の内容でプランを変更しました。"),1),(0,l.createVNode)(k.Jn,{variant:"outlined",class:"pa-3"},{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",X,(0,l.toDisplayString)((0,l.unref)(x).find((e=>e.planId===re.selectedPlan))?.name),1),"business"===re.selectedPlan?((0,l.openBlock)(),(0,l.createElementBlock)(l.Fragment,{key:0},[(0,l.createElementVNode)("div",ee," アカウント数: "+(0,l.toDisplayString)(re.accountCount),1),(0,l.createElementVNode)("div",te," 月額料金: ¥"+(0,l.toDisplayString)((0,l.unref)(x).find((e=>"business"===e.planId)).getPrice(re.accountCount).toLocaleString())+"/月 ",1)],64)):"pro"===re.selectedPlan?((0,l.openBlock)(),(0,l.createElementBlock)("div",ae," 月額料金: ¥"+(0,l.toDisplayString)((0,l.unref)(x).find((e=>"pro"===e.planId)).price.toLocaleString())+"/月 ",1)):((0,l.openBlock)(),(0,l.createElementBlock)("div",le," 無料 "))])),_:1})])),_:1}),(0,l.createVNode)(k.SL,null,{default:(0,l.withCtx)((()=>[(0,l.createVNode)(I.hc),(0,l.createVNode)(d.D,{color:"primary",text:"",onClick:f},{default:(0,l.withCtx)((()=>t[34]||(t[34]=[(0,l.createTextVNode)(" 閉じる ")]))),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"]))}};const oe=(0,x.A)(ne,[["__scopeId","data-v-5c66966e"]]);var re=oe,ce=a(1512);const ie={class:"text-h6 font-weight-bold"},se={class:"text-body-1 mt-2 px-4"},ue={key:0},de={key:1},pe={key:0,class:"text-caption px-4"},me={key:1,class:"text-caption px-4 text-warning"},ve={key:0,class:"text-caption text-warning"},fe={class:"text-center"},he={class:"text-center"},we={key:1,class:"text-center py-4"},ye={class:"text-body-1 text-medium-emphasis"};var xe={__name:"Billing",setup(e){const t=(0,n.Pj)(),{plans:a}=(0,o.t)(),s=(0,l.ref)(!1),u=(0,l.ref)(null),p=(0,l.ref)([]),m=(0,l.ref)(!1),v=(0,l.computed)((()=>(0,i.P8)())),f=(0,l.computed)((()=>(0,i.zN)())),h=(0,l.computed)((()=>v.value.name)),w=(0,l.computed)((()=>"business"===v.value.planId&&f.value?.accountCount?v.value.getPrice(f.value.accountCount):v.value.price)),y=(0,l.ref)(null),x=(0,l.ref)(null),N=(0,l.ref)({}),V=()=>{(0,l.nextTick)((()=>{const e=y.value?.$el.offsetHeight||0,t=x.value?.$el.offsetHeight||0,a=80,l=`calc(100vh - ${e+t+a}px)`;N.value={maxHeight:l,overflowY:"auto"}}))};(0,l.onMounted)((()=>{V(),window.addEventListener("resize",V)})),(0,l.onUnmounted)((()=>{window.removeEventListener("resize",V)}));const b=async e=>{try{if(s.value=!0,u.value=null,e){const t=await(0,r.NP)(e);p.value=t.data.invoices}else p.value=[]}catch(t){u.value="請求履歴の取得に失敗しました",p.value=[]}finally{s.value=!1}},E=e=>{if(!e)return"";const t=new Date(1e3*e),a={year:"numeric",month:"2-digit",day:"2-digit"};return t.toLocaleDateString("ja-JP",a)},_=e=>{const t=e<0?"-":"";return`${t}${Math.abs(e).toLocaleString()}円`},S=e=>e.upcoming?"warning":"refund"===e.type?"info":"paid"===e.status?"light-blue-lighten-4":"warning",P=e=>e.upcoming?"保留中":"refund"===e.type?"返金済み":"paid"===e.status?"支払い済み":"未払い",D=(0,l.computed)((()=>t.getters["auth/isParentAccount"])),T=async()=>{D.value?m.value=!0:t.dispatch("showNotification",{message:"子アカウントではプランを変更できません",type:"warning"})},z=async()=>{if(!D.value)return void t.dispatch("showNotification",{message:"子アカウントでは支払い設定を変更できません",type:"warning"});const e=t.getters["auth/organizationId"];try{const t=f.value?.planId||"free",l=a.find((e=>e.planId===t));if(!l)throw new Error("Invalid plan");await(0,c.ao)(e,l.organizationFeatures),f.value?.stripeCustomerId&&await b(f.value.stripeCustomerId)}catch(u){}},L=e=>{e&&window.open(e,"_blank")};return(0,l.onMounted)((async()=>{if(D.value)try{f.value?.stripeCustomerId&&await b(f.value.stripeCustomerId)}catch(u){}})),(e,t)=>((0,l.openBlock)(),(0,l.createBlock)(I.IZ,null,{default:(0,l.withCtx)((()=>[D.value?((0,l.openBlock)(),(0,l.createElementBlock)(l.Fragment,{key:1},[(0,l.createVNode)(I.Li,{ref_key:"headerRef",ref:y,dense:"",class:"pb-4"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(I.B6,null,{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("h3",null,[(0,l.createVNode)(B.wP,{size:"large",class:"mr-1"},{default:(0,l.withCtx)((()=>t[3]||(t[3]=[(0,l.createTextVNode)("mdi-wallet-outline")]))),_:1}),t[4]||(t[4]=(0,l.createTextVNode)(" 支払い設定 "))])])),_:1})])),_:1},512),(0,l.createVNode)(re,{modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=e=>m.value=e),onPaymentSuccess:z},null,8,["modelValue"]),(0,l.createVNode)(k.Jn,{ref_key:"planCardRef",ref:x},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.ri,null,{default:(0,l.withCtx)((()=>t[5]||(t[5]=[(0,l.createTextVNode)("現在のプラン")]))),_:1}),(0,l.createVNode)(k.OQ,null,{default:(0,l.withCtx)((()=>[(0,l.createVNode)(I.Li,{align:"center"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(I.B6,{class:"me-auto"},{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("div",ie,(0,l.toDisplayString)(h.value),1),(0,l.createElementVNode)("p",se,[0===w.value?((0,l.openBlock)(),(0,l.createElementBlock)("span",ue,"無料")):((0,l.openBlock)(),(0,l.createElementBlock)("span",de,(0,l.toDisplayString)(w.value)+"円/月",1))]),f.value?.accountCount>0?((0,l.openBlock)(),(0,l.createElementBlock)("p",pe," アカウント数: "+(0,l.toDisplayString)(f.value.accountCount),1)):(0,l.createCommentVNode)("",!0),f.value?.currentPeriodEnd?((0,l.openBlock)(),(0,l.createElementBlock)("p",me," ※ "+(0,l.toDisplayString)(E(f.value.currentPeriodEnd))+"まで現在のプランが有効です ",1)):(0,l.createCommentVNode)("",!0)])),_:1}),(0,l.createVNode)(I.B6,{cols:"12",md:"auto"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(d.D,{color:"primary",onClick:T},{default:(0,l.withCtx)((()=>t[6]||(t[6]=[(0,l.createTextVNode)(" プランを変更 ")]))),_:1})])),_:1})])),_:1})])),_:1})])),_:1},512),(0,l.createVNode)(k.Jn,{class:"mt-4"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(k.ri,null,{default:(0,l.withCtx)((()=>t[7]||(t[7]=[(0,l.createTextVNode)("請求履歴")]))),_:1}),(0,l.createVNode)(k.OQ,{style:(0,l.normalizeStyle)(N.value)},{default:(0,l.withCtx)((()=>[p.value.length>0?((0,l.openBlock)(),(0,l.createBlock)(ce.Z,{key:0},{default:(0,l.withCtx)((()=>[t[9]||(t[9]=(0,l.createElementVNode)("thead",null,[(0,l.createElementVNode)("tr",null,[(0,l.createElementVNode)("th",null,"日付"),(0,l.createElementVNode)("th",null,"内容"),(0,l.createElementVNode)("th",{class:"text-center"},"金額"),(0,l.createElementVNode)("th",{class:"text-center"},"ステータス"),(0,l.createElementVNode)("th",{class:"text-center"},"請求書")])],-1)),(0,l.createElementVNode)("tbody",null,[((0,l.openBlock)(!0),(0,l.createElementBlock)(l.Fragment,null,(0,l.renderList)(p.value,(e=>((0,l.openBlock)(),(0,l.createElementBlock)("tr",{key:e.id},[(0,l.createElementVNode)("td",null,(0,l.toDisplayString)(E(e.date)),1),(0,l.createElementVNode)("td",null,[(0,l.createElementVNode)("div",null,(0,l.toDisplayString)(e.description),1),e.upcoming?((0,l.openBlock)(),(0,l.createElementBlock)("div",ve," ※次回請求時に反映 ")):(0,l.createCommentVNode)("",!0)]),(0,l.createElementVNode)("td",{class:(0,l.normalizeClass)([{"text-error":e.amount<0,"text-warning":e.upcoming},"text-right"])},(0,l.toDisplayString)(_(e.amount)),3),(0,l.createElementVNode)("td",fe,[(0,l.createVNode)(C.x,{color:S(e),variant:e.upcoming?"outlined":"flat",size:"small"},{default:(0,l.withCtx)((()=>[(0,l.createTextVNode)((0,l.toDisplayString)(P(e)),1)])),_:2},1032,["color","variant"])]),(0,l.createElementVNode)("td",he,[e.url?((0,l.openBlock)(),(0,l.createBlock)(d.D,{key:0,variant:"text",size:"large",color:"primary",onClick:t=>L(e.url)},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(B.wP,{size:"large"},{default:(0,l.withCtx)((()=>t[8]||(t[8]=[(0,l.createTextVNode)("mdi-open-in-new")]))),_:1})])),_:2},1032,["onClick"])):(0,l.createCommentVNode)("",!0)])])))),128))])])),_:1})):((0,l.openBlock)(),(0,l.createElementBlock)("div",we,[(0,l.createElementVNode)("p",ye,(0,l.toDisplayString)(s.value?"読み込み中...":"請求履歴がありません"),1)]))])),_:1},8,["style"])])),_:1})],64)):((0,l.openBlock)(),(0,l.createElementBlock)(l.Fragment,{key:0},[(0,l.createVNode)(I.Li,{dense:"",class:"pb-4"},{default:(0,l.withCtx)((()=>[(0,l.createVNode)(I.B6,null,{default:(0,l.withCtx)((()=>[(0,l.createElementVNode)("h3",null,[(0,l.createVNode)(B.wP,{size:"large",class:"mr-1"},{default:(0,l.withCtx)((()=>t[1]||(t[1]=[(0,l.createTextVNode)("mdi-wallet-outline")]))),_:1}),t[2]||(t[2]=(0,l.createTextVNode)(" 支払い設定 "))])])),_:1})])),_:1}),(0,l.createVNode)(g.l,{type:"warning",title:"アクセス制限",text:"子アカウントでは支払い設定にアクセスできません。親アカウントで操作してください。"})],64))])),_:1}))}};const Ne=xe;var Ve=Ne}}]);
//# sourceMappingURL=73.33bb276c.js.map